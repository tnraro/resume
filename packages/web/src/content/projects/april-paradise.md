---
title: 4월의 낙원호
github: https://github.com/tnraro/april-paradise
stack:
  - Svelte 5 (SvelteKit)
  - EdgeDB
  - Docker
  - Sentry
begin: 2024-03-05
end: 2024-04-22
priority: 0
---

4월의 낙원호는 사용자 인증, 재화 시스템, 미니 게임(슬롯머신, 낚시, 선택지 게임), 출석 체크, 우편, 상점, 가방 기능을 제공하는 웹 게임입니다. 또한, 참가자 관리, 보상 지급, 공지 사항 작성, 상점을 관리할 수 있는 운영자 페이지를 제공합니다. 

- EdgeDB 도입 배경
	- 유연함과 엄격한 스키마를 동시에 가지며, 복잡한 질의도 직관적으로 작성할 수 있음.
	- 비즈니스 로직을 디비에 담아서 중복과 오류 가능성을 사전에 제거할 수 있음.
- API 응답 속도 43배 단축하기
	- 서비스 첫날 API 끝점 응답 속도가 평균 2,322ms, 최대 20초까지 느려지고 트랜잭션 실패가 발생함.
	- 클라이언트 반응성을 올리기 위해 클라이언트에서 처리가 완료된 것으로 표시하고, 디비에서 나중에 처리하는 방식을 사용하였는데, 트랜잭션 실패로 사용자의 인식 불일치를 가져옴.
	- 우선 사용자 인식 불일치를 줄이는 방향으로 핫픽스 후 진짜 원인을 분석.
	- 사용자 인증에 사용하는 `ext::auth::ClientTokenIdentity`가 느리고, 여러 번 가져오는 것을 확인.
	- API 끝점 당 한 번씩 질의하고 재사용 하도록 변경.
	- 평균 2,322ms 걸리든 응답 속도가 54ms로 줄어듦.
- 권한 및 테이블 상속
	- 처음에는 관리자와 사용자가 User를 상속하는 다른 테이블이었음.
	- 만들다 보니 관리자는 사용자의 슈퍼셋이었음. 따라서 하나의 테이블로 합치고 권한을 속성으로 옮김.
	- 언제든지 사용자와 관리자 전환 가능해지고, 사용자의 모든 기능을 관리자도 사용 가능해짐.
- 동시 편집
	- 운영자 페이지를 여러 명이 동시에 수정하면 상태가 꼬일 것을 우려.
	- CRDT 라이브러리인 Y.js와 Liveblocks 서비스를 조사.
	- Liveblocks는 월 사용자 100명 미만이면 완전 무료여서 바로 도입.
	- 구현해 보니 엑셀과 유사한 형태가 되어서, 구글 스프레드시트를 쓰는 것으로 전환.
	- 스프레드시트 제한이 빡빡해서 정적 데이터만 스프레드시트에 둠.
	- 스프레드시트가 죽으니까 앱 전체가 멈추는 버그가 생겨서 디비에 캐싱함.
- 타입 세이프한 API 클라이언트
	- 타입 세이프한 api 요청을 구현하고 싶었음.
	- tRPC, ElysiaJS를 써봤지만 모두 SvelteKit과 매끄럽게 동작하지 않았음.
	- 결국 `/routes/api/**/+server.ts`를 모두 읽고 클라이언트 코드를 생성하게 만듦.
	- 예시: `api().mail.post({ id }, body)` -> `POST /api/mail/[id]`
	- 코드 생성과 fetch 래퍼로 정확히 원하는 동작을 간단히 구현할 수 있었음.
- 디자인 시스템 및 UI 컴포넌트
	- 기본 요소를 스타일링하는 pico.css에 영향을 받음.
	- portal, modal 같은 간단한 컴포넌트는 직접 구현
	- 복잡한 상태를 가지는 컴포넌트는 Bits UI(Radix UI에 영향을 받은 Svelte 용 헤드리스 컴포넌트)를 사용.
- Stylebook
	- 컴포넌트가 늘어나자, Storybook이 필요해졌으나, Svelte 5를 지원하지 않음.
	- 필요한 기능만 들어있는 유사 Storybook을 구현
	- 컴포넌트 옆에 stylebook 파일을 추가하면 동적으로 import하게 구현.
- 미니 게임 애니메이션
	- SVG를 Svelte 컴포넌트에서 다루도록 구현
- 인앱 브라우저 대응
	- 특정 환경에서 인앱 브라우저가 쿠키를 유지하지 못해서 매번 로그인해야 하는 문제 발생
	- 안드로이드는 강제로 특정 브라우저를 열 방법이 있으나, iOS는 불가능함.
	- 중요한 문제였지만 해결 할 수 없어서 관둠.
- 원인을 알 수 없는 버그
	- 특정 주소에서 502 Bad Gateway가 뜸.
	- 개발환경과 빌드 결과물에선 멀쩡한데, 서버에서 안 돌아감.
	- 구체적인 원인은 찾지 못했지만, SSR 중에 발생하는 문제였음.
	- 결국 SSR 끄고 SPA로 전환함.
- 성과 및 통계
	- 사용자 수: 33명
	- 제명된 사용자 수: 4명
	- 보낸 우편 수: 280건
	- 가장 많은 칩을 얻은 사용자의 칩 수: 6,560칩
	- 가장 많은 토큰을 얻은 사용자의 토큰 수: 97토큰
	- 출석 체크를 매일 하신 사용자: 5명
	- 낚시 업적을 모두 달성한 사용자: 2명
	- 가장 많이 낚시를 하신 사용자의 낚시 횟수: 290회
	- 가장 많은 아이템을 보유하신 사용자의 아이템 수: 295개